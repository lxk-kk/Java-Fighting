#### 【RabbitMQ原理】

##### 结构图

<img src="material\7_RabbitMQ原理图_1.png" style="zoom:125%;" />

![](material\7_RabbitMQ原理图_2.png)

1. Message 消息

   ```xml
   <!-- 消息 -->
   消息是不具名的，它由消息头和消息体组成。
   	消息体：传输消息的内容，是不透明的。
   	消息头：由一系列可选属性组成，包括：routing-Key（路由键）、priority（相对于其他消息的优先权）、delivery-mode（指出消息可能持久化存储）等等，这些属性，在发送消息时，可以通过注解的形式设置！
   ```

2. Publisher 消息的生产者：也是一个向`交换器`发布消息的`客户端应用程序`。

3. Consumer 消息的消费者：表示从一个`消息队列`中获取消息的`客户端应用程序`。

4. Exchange 交换器

   ```xml
   <!-- 交换器 -->
   用于接收生产者发送的消息，并将消息 路由 给服务器中的 队列。
   三种常用的交换器类型：
    1、direct（发布与订阅：完全匹配）
    2、fanout（广播）
    3、topic （主题：规则匹配）
   这三种交换器类型，将决定MQ采用哪一种 队列 保存信息，即 Publisher 发送的消息并不是直接进入 queue 中，是经过交换器，由交换器决定将消息保存到哪个队列当中。
   ```

5. Binding 绑定

   ```xml
   <!-- 绑定 -->
   绑定：用于消息队列和交换器之间的关联。一个绑定就是基于 路由键 将 交换器 和 消息队列 连接起来的规则，所以可以将交换器理解成一个由绑定构成的路由表
   	交换器在将消息发送给消息队列时，肯定需要知道队列的存在，所以交换器与队列之间肯定要做一个绑定的处理，如何进行绑定呢？或者说根据什么进行绑定呢？实际上是根据 路由键 进行绑定！
   在 Pulisher 发送消息时，如果 消息头 中的路由键信息与 vhost 中的某个路由键相同，则路由器就会将信息发送到该路由键所对应的队列中。
   ```

6. Queue

   ```xml
   <!-- 队列 -->
   消息队列：用来保存消息直到发送给消费者。它是消息的 容器 ，也是消息的 终点 。一个消息可投入一个或者多个队列，消息一直在队列里面，等待消费者连接到这个队列，并将消息取走。
   ```

7. Routing-key

   ```xml
   <!-- 路由键 -->
   路由键：RabbitMQ 决定消息该投递到哪个队列的规则。
   	队列通过路由键绑定到交换器。
   	消息发送到 MQ 服务器时，消息将拥有一个路由键，即便是空的，RabbitMQ 也会将其和绑定使用的路由键进行匹配。
   	如果相匹配，则消息将会投递到该队列中。
   	如果不匹配，消息将会进入到黑洞（一个专门的队列，老版本的 RabbitMQ 将会直接丢弃该消息！）
   ```

8. Connection

   ```xml
   <!-- 链接 -->
   链接：指 RabbitMQ 服务器和服务建立的 TCP 链接。
   消息都是储存在队列中，而消费者要取走消息，就必须与 MQ 建立 TCP 连接，这个连接就是 Connection
   ```

9. Channel

   ```xml
   <!-- 信道 -->
   1) Channel 信道，是 TCP 里面的 虚拟连接，一条 TCP 连接上和创建多条信道是没有问题的，即在一个链接当中可以开辟多条通信的通道！
   	例如：电缆相当于 TCP ，信道是一个独立的光纤束。
   	为什么不直接使用 TCP 链接进行通信呢？
   2) TCP 一旦代开，就会创建 AMQP 信道。
   3) 无论是 发布消息、节后苏消息、订阅队列，这些动作都是通过信道完成的。
   ```

10. Virtual Host

   ```xml
   <!-- 虚拟主机 -->
   虚拟主机：表示一批交换器、消息队列和相关对象。
   	虚拟主机是共享相同的 身份认证和加密环境 的独立服务器域。每个 vhost 本质上就是一个 mini 版的 RabbitMQ 服务器，拥有自己的队列、交换器、绑定和权限机制。
   	一个 虚拟主机 就包含了完整的 RabbitMQ 的通信机制：队列、交换器、绑定和权限机制。
   	虚拟主机与虚拟主机之间是隔离、相互独立的，每个虚拟主机中 使用的用户的权限是针对虚拟主机设置的，不能跨虚拟主机。
   	在 RabbitMQ 当中可以添加多个虚拟主机，就像在 MySQL 中可以创建多个 数据库！
   	vhost 是 AMQP 概念的基础，必须在连接时指定，RabbitMQ 默认的 vhost 是 / 。
   ```

11. Broker

    ```xml
    <!-- Broker -->
    指 RabbitMQ 服务器的实体。
    ```

+ 交换器 和 队列的关系

  + `交换器`是通过`路由键`和`队列`绑定在一起的，如果消息拥有的`路由键`跟`队列`和`交换器`的路由键匹配，那么消息就会被`路由`到该绑定的队列中。
  + 消息到队列的过程：消息首先会经过交换器，接下来交换器再通过`路由键`匹配分发消息到具体的队列中。路由键 可以理解为匹配的规则。

+ RabbitMQ 为什么需要信道？为什么不是 TCP 链接直接进行通信？

  1. TCP 的创建和销毁开销大：创建 TCP 链接需要`3次握手`，取消 TCP 链接需要`4次挥手`
  2. 如果不使用信道，应用程序就会以 TCP 链接 RabbitMQ，高峰时每秒成千上万条链接会造成巨大的资源浪费，并且操作系统每秒处理的 TCP 链接数是有限的，如此以来，肯定会造成性能瓶颈！
  3. 信道的原理：一条线程一个通道，多条线程多条通道共用一个 TCP 链接。一条 TCP 链接可以容纳无限的信道，即使每秒成千上万的请求也不会成为性能的瓶颈。
